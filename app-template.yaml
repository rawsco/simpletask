AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Task Manager Application - Serverless Task Management System

Parameters:
  Environment:
    Type: String
    Description: Environment name (staging or production)
    AllowedValues:
      - staging
      - production
    Default: staging

Globals:
  Function:
    Runtime: nodejs22.x
    Timeout: 30
    MemorySize: 512
    Environment:
      Variables:
        NODE_ENV: production
        ENVIRONMENT: !Ref Environment
    Tags:
      Environment: !Ref Environment
      Service: TaskManager
      Owner: TaskManagerTeam
      CostCenter: Engineering
      Application: TaskManager

Resources:
  # ========================================
  # DynamoDB Tables
  # ========================================
  
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'TaskManager-Users-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: email
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: email
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  TasksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'TaskManager-Tasks-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: taskId
          AttributeType: S
        - AttributeName: order
          AttributeType: N
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: taskId
          KeyType: RANGE
      LocalSecondaryIndexes:
        - IndexName: OrderIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: order
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'TaskManager-Sessions-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionToken
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: N
      KeySchema:
        - AttributeName: sessionToken
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserSessionsIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  AuditLogTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'TaskManager-AuditLog-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: eventId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: userId
          AttributeType: S
        - AttributeName: eventType
          AttributeType: S
      KeySchema:
        - AttributeName: eventId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: UserEventsIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: EventTypeIndex
          KeySchema:
            - AttributeName: eventType
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  RateLimitsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'TaskManager-RateLimits-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: limitKey
          AttributeType: S
        - AttributeName: windowStart
          AttributeType: N
      KeySchema:
        - AttributeName: limitKey
          KeyType: HASH
        - AttributeName: windowStart
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  # ========================================
  # Secrets Manager
  # ========================================
  
  DBEncryptionSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'TaskManager/${Environment}/DBEncryptionKey'
      Description: Encryption key for sensitive database fields
      GenerateSecretString:
        SecretStringTemplate: '{"keyVersion": "1"}'
        GenerateStringKey: encryptionKey
        PasswordLength: 32
        ExcludePunctuation: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  JWTSigningSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'TaskManager/${Environment}/JWTSigningKey'
      Description: JWT signing key for session tokens
      GenerateSecretString:
        SecretStringTemplate: '{"keyVersion": "1"}'
        GenerateStringKey: signingKey
        PasswordLength: 64
        ExcludePunctuation: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  # ========================================
  # Lambda Execution Role
  # ========================================
  
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'TaskManager-LambdaExecutionRole-${Environment}'
      Path: /service-role/
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt UsersTable.Arn
                  - !GetAtt TasksTable.Arn
                  - !GetAtt SessionsTable.Arn
                  - !GetAtt AuditLogTable.Arn
                  - !GetAtt RateLimitsTable.Arn
                  - !Sub '${UsersTable.Arn}/index/*'
                  - !Sub '${TasksTable.Arn}/index/*'
                  - !Sub '${SessionsTable.Arn}/index/*'
                  - !Sub '${AuditLogTable.Arn}/index/*'
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref DBEncryptionSecret
                  - !Ref JWTSigningSecret
        - PolicyName: SESAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  # ========================================
  # Lambda Functions
  # ========================================
  
  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'TaskManager-AuthHandler-${Environment}'
      CodeUri: lambda/
      Handler: auth-handler-main.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTable
          SESSIONS_TABLE_NAME: !Ref SessionsTable
          AUDIT_LOG_TABLE_NAME: !Ref AuditLogTable
          RATE_LIMITS_TABLE_NAME: !Ref RateLimitsTable
          DB_ENCRYPTION_SECRET_ARN: !Ref DBEncryptionSecret
          JWT_SIGNING_SECRET_ARN: !Ref JWTSigningSecret
      Events:
        AuthApi:
          Type: Api
          Properties:
            RestApiId: !Ref TaskManagerApi
            Path: /auth/{proxy+}
            Method: ANY

  TaskFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'TaskManager-TaskHandler-${Environment}'
      CodeUri: lambda/
      Handler: task-handler-main.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTable
          TASKS_TABLE_NAME: !Ref TasksTable
          SESSIONS_TABLE_NAME: !Ref SessionsTable
          AUDIT_LOG_TABLE_NAME: !Ref AuditLogTable
          RATE_LIMITS_TABLE_NAME: !Ref RateLimitsTable
          DB_ENCRYPTION_SECRET_ARN: !Ref DBEncryptionSecret
          JWT_SIGNING_SECRET_ARN: !Ref JWTSigningSecret
      Events:
        TasksApi:
          Type: Api
          Properties:
            RestApiId: !Ref TaskManagerApi
            Path: /tasks/{proxy+}
            Method: ANY
        TasksRootApi:
          Type: Api
          Properties:
            RestApiId: !Ref TaskManagerApi
            Path: /tasks
            Method: ANY

  BackupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'TaskManager-BackupHandler-${Environment}'
      CodeUri: lambda/
      Handler: backup-handler.handler
      Role: !GetAtt BackupRole.Arn
      Timeout: 600
      MemorySize: 256
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTable
          TASKS_TABLE_NAME: !Ref TasksTable
          SESSIONS_TABLE_NAME: !Ref SessionsTable
          AUDIT_LOG_TABLE_NAME: !Ref AuditLogTable
      Events:
        DailyBackup:
          Type: Schedule
          Properties:
            Schedule: cron(0 3 * * ? *)
            Description: Daily backup at 3 AM UTC

  LogCleanupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'TaskManager-LogCleanup-${Environment}'
      CodeUri: lambda/
      Handler: log-cleanup-handler.handler
      Role: !GetAtt LogCleanupRole.Arn
      Timeout: 300
      MemorySize: 256
      Environment:
        Variables:
          LOG_GROUPS: !Sub '/aws/lambda/TaskManager-AuthHandler-${Environment},/aws/lambda/TaskManager-TaskHandler-${Environment}'
      Events:
        DailyCleanup:
          Type: Schedule
          Properties:
            Schedule: cron(0 2 * * ? *)
            Description: Daily log cleanup at 2 AM UTC

  # ========================================
  # IAM Roles for Backup and Cleanup
  # ========================================
  
  BackupRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'TaskManager-BackupRole-${Environment}'
      Path: /service-role/
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBBackupAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:CreateBackup
                  - dynamodb:DescribeBackup
                  - dynamodb:ListBackups
                  - dynamodb:DeleteBackup
                Resource:
                  - !GetAtt UsersTable.Arn
                  - !GetAtt TasksTable.Arn
                  - !GetAtt SessionsTable.Arn
                  - !GetAtt AuditLogTable.Arn
                  - !Sub '${UsersTable.Arn}/backup/*'
                  - !Sub '${TasksTable.Arn}/backup/*'
                  - !Sub '${SessionsTable.Arn}/backup/*'
                  - !Sub '${AuditLogTable.Arn}/backup/*'

  LogCleanupRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'TaskManager-LogCleanupRole-${Environment}'
      Path: /service-role/
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LogCleanupAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:DescribeLogStreams
                  - logs:DeleteLogStream
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/TaskManager-*:*'

  # ========================================
  # API Gateway
  # ========================================
  
  TaskManagerApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub 'TaskManager-API-${Environment}'
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
        MaxAge: "'3600'"
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          ThrottlingRateLimit: 100
          ThrottlingBurstLimit: 200
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true
      Tags:
        Environment: !Ref Environment
        Service: TaskManager

  # ========================================
  # SNS Topic for Alarms
  # ========================================
  
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'TaskManager-Alarms-${Environment}'
      DisplayName: Task Manager Alarm Notifications
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  # ========================================
  # CloudWatch Alarms
  # ========================================
  
  AuthFunctionErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'TaskManager-AuthFunction-Errors-${Environment}'
      AlarmDescription: Alert when auth function error rate is high
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref AuthFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  TaskFunctionErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'TaskManager-TaskFunction-Errors-${Environment}'
      AlarmDescription: Alert when task function error rate is high
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref TaskFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  API4xxErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'TaskManager-API4xxErrors-${Environment}'
      AlarmDescription: Alert when API 4XX error rate is high
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 100
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub 'TaskManager-API-${Environment}'
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  API5xxErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'TaskManager-API5xxErrors-${Environment}'
      AlarmDescription: Alert when API 5XX error rate is high
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub 'TaskManager-API-${Environment}'
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  BackupFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'TaskManager-BackupFailures-${Environment}'
      AlarmDescription: Alert when backup function fails
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 86400
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref BackupFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # ========================================
  # S3 Buckets
  # ========================================
  
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'taskmanager-frontend-${AWS::AccountId}-${Environment}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: IntelligentTiering
            Status: Enabled
            Transitions:
              - TransitionInDays: 0
                StorageClass: INTELLIGENT_TIERING
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  CloudFrontLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'taskmanager-cloudfront-logs-${AWS::AccountId}-${Environment}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 30
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'taskmanager-cloudtrail-${AWS::AccountId}-${Environment}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 365
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  # ========================================
  # CloudFront Distribution
  # ========================================

  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub 'OAI for TaskManager frontend bucket ${Environment}'

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: CloudFrontReadAccess
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub '${FrontendBucket.Arn}/*'

  FrontendCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub 'TaskManager-Frontend-Cache-${Environment}'
        Comment: Cache policy for frontend static assets
        DefaultTTL: 300
        MinTTL: 0
        MaxTTL: 86400
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: none
          HeadersConfig:
            HeaderBehavior: none
          CookiesConfig:
            CookieBehavior: none

  FrontendDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: !Sub 'TaskManager Frontend Distribution ${Environment}'
        Enabled: true
        DefaultRootObject: index.html
        PriceClass: PriceClass_100
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}'
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          Compress: true
          CachePolicyId: !Ref FrontendCachePolicy
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
          MinimumProtocolVersion: TLSv1.2_2021
        Logging:
          Bucket: !GetAtt CloudFrontLogBucket.DomainName
          IncludeCookies: false
          Prefix: cloudfront-logs/
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

  CacheHitRatioAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'TaskManager-CloudFront-LowCacheHitRatio-${Environment}'
      AlarmDescription: Alert when CloudFront cache hit ratio falls below 80%
      MetricName: CacheHitRate
      Namespace: AWS/CloudFront
      Statistic: Average
      Period: 3600
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: DistributionId
          Value: !Ref FrontendDistribution
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # ========================================
  # AWS Budget
  # ========================================

  CostBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub 'TaskManager-MonthlyBudget-${Environment}'
        BudgetType: COST
        TimeUnit: MONTHLY
        BudgetLimit:
          Amount: 10
          Unit: USD
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 80
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: SNS
              Address: !Ref AlarmTopic
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 100
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: SNS
              Address: !Ref AlarmTopic

  # ========================================
  # CloudWatch Dashboard
  # ========================================

  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub 'TaskManager-Monitoring-${Environment}'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "Count", {"stat": "Sum", "label": "Total Requests"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "API Gateway - Request Count",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "Latency", {"stat": "Average", "label": "Average"}],
                  ["...", {"stat": "p95", "label": "p95"}],
                  ["...", {"stat": "p99", "label": "p99"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "API Gateway - Latency",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "4XXError", {"stat": "Sum", "label": "4XX Errors"}],
                  [".", "5XXError", {"stat": "Sum", "label": "5XX Errors"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "API Gateway - Error Rate",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "Auth Function"}, {"dimensions": {"FunctionName": "${AuthFunction}"}}],
                  ["...", {"dimensions": {"FunctionName": "${TaskFunction}"}, "label": "Task Function"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda - Invocations",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", {"stat": "Average", "label": "Auth Avg"}, {"dimensions": {"FunctionName": "${AuthFunction}"}}],
                  ["...", {"dimensions": {"FunctionName": "${TaskFunction}"}, "label": "Task Avg"}],
                  ["...", {"stat": "p95", "label": "Auth p95"}, {"dimensions": {"FunctionName": "${AuthFunction}"}}],
                  ["...", {"dimensions": {"FunctionName": "${TaskFunction}"}, "label": "Task p95"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda - Duration",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", {"stat": "Sum", "label": "Auth Function"}, {"dimensions": {"FunctionName": "${AuthFunction}"}}],
                  ["...", {"dimensions": {"FunctionName": "${TaskFunction}"}, "label": "Task Function"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda - Errors",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum", "label": "Users"}, {"dimensions": {"TableName": "${UsersTable}"}}],
                  ["...", {"dimensions": {"TableName": "${TasksTable}"}, "label": "Tasks"}],
                  ["...", {"dimensions": {"TableName": "${SessionsTable}"}, "label": "Sessions"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB - Read Capacity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedWriteCapacityUnits", {"stat": "Sum", "label": "Users"}, {"dimensions": {"TableName": "${UsersTable}"}}],
                  ["...", {"dimensions": {"TableName": "${TasksTable}"}, "label": "Tasks"}],
                  ["...", {"dimensions": {"TableName": "${SessionsTable}"}, "label": "Sessions"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB - Write Capacity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/CloudFront", "CacheHitRate", {"stat": "Average"}, {"dimensions": {"DistributionId": "${FrontendDistribution}"}}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "CloudFront - Cache Hit Rate",
                "yAxis": {"left": {"min": 0, "max": 100}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/CloudFront", "Requests", {"stat": "Sum"}, {"dimensions": {"DistributionId": "${FrontendDistribution}"}}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "CloudFront - Requests",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Billing", "EstimatedCharges", {"stat": "Maximum"}, {"dimensions": {"Currency": "USD"}}]
                ],
                "period": 21600,
                "stat": "Maximum",
                "region": "us-east-1",
                "title": "Estimated Monthly Cost",
                "yAxis": {"left": {"min": 0}}
              }
            }
          ]
        }

  CloudTrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailBucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${CloudTrailBucket.Arn}/*'
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control

  # ========================================
  # CloudTrail
  # ========================================
  
  CloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn: CloudTrailBucketPolicy
    Properties:
      TrailName: !Sub 'TaskManager-Trail-${Environment}'
      S3BucketName: !Ref CloudTrailBucket
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
          DataResources:
            - Type: AWS::DynamoDB::Table
              Values:
                - !GetAtt UsersTable.Arn
                - !GetAtt TasksTable.Arn
                - !GetAtt SessionsTable.Arn
                - !GetAtt AuditLogTable.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: TaskManager

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${TaskManagerApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  FrontendBucketName:
    Description: S3 bucket for frontend hosting
    Value: !Ref FrontendBucket
    Export:
      Name: !Sub '${AWS::StackName}-FrontendBucket'

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref FrontendDistribution
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontDistributionId'

  CloudFrontDomainName:
    Description: CloudFront distribution domain name (HTTPS enforced)
    Value: !GetAtt FrontendDistribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontDomain'

  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=TaskManager-Monitoring-${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-DashboardURL'

  AlarmTopicArn:
    Description: SNS topic ARN for alarm notifications
    Value: !Ref AlarmTopic
    Export:
      Name: !Sub '${AWS::StackName}-AlarmTopic'

  UsersTableName:
    Description: DynamoDB Users table name
    Value: !Ref UsersTable
    Export:
      Name: !Sub '${AWS::StackName}-UsersTable'

  TasksTableName:
    Description: DynamoDB Tasks table name
    Value: !Ref TasksTable
    Export:
      Name: !Sub '${AWS::StackName}-TasksTable'

  AuthFunctionArn:
    Description: Auth Lambda function ARN
    Value: !GetAtt AuthFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AuthFunction'

  TaskFunctionArn:
    Description: Task Lambda function ARN
    Value: !GetAtt TaskFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TaskFunction'
